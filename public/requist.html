<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Requests - CampusCare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
        :root { --main-bg: #f7f9fc; --sidebar-blue: #1e3a8a; }
        body { background: var(--main-bg); min-height: 100vh; }
        
        /* Sidebar Styles */
        .sidebar { position: fixed; left: 0; top: 0; height: 100%; width: 260px; background: var(--sidebar-blue); padding: 10px 14px; transition: all 0.4s ease; z-index: 100; }
        .sidebar.close { width: 78px; }
        .sidebar .logo-details { display: flex; align-items: center; height: 60px; position: relative; }
        .sidebar .logo-details .logo-img { height: 40px; }
        .sidebar .logo-details #btn { position: absolute; right: 0; top: 50%; transform: translateY(-50%); font-size: 22px; cursor: pointer; color: #fff; width: 50px; text-align: center; }
        .sidebar.close .logo-details #btn { right: 50%; transform: translate(50%, -50%); }
        .sidebar .nav-links { margin-top: 20px; height: calc(100% - 160px); overflow: auto; padding: 0; }
        .sidebar .nav-links::-webkit-scrollbar { display: none; }
        .sidebar .nav-links li { list-style: none; margin: 8px 0; position: relative; }
        .sidebar .nav-links li a { display: flex; align-items: center; text-decoration: none; color: #E0E0E0; border-radius: 12px; padding: 12px; transition: all 0.3s ease; }
        .sidebar .nav-links li a:hover { background: #ffffff1a; color: #fff; }
        .sidebar .nav-links li a.active { background: #fff; color: #11101D; font-weight: 500; }
        .sidebar .nav-links li i { min-width: 50px; text-align: center; font-size: 18px; }
        .sidebar .profile-details { position: absolute; bottom: 0; left: 0; width: 260px; background: #1d1b31; padding: 12px; display: flex; align-items: center; transition: all 0.4s ease; }
        .sidebar.close .profile-details { width: 78px; background: none; justify-content: center; }
        .sidebar.close .profile-details img { height: 48px; width: 48px; object-fit: cover; border-radius: 12px; margin-right: 10px; flex-shrink: 0; }
        .sidebar.close .profile-details img { margin-right: 0; }
        .sidebar.close .profile-details .profile_name, .sidebar.close .profile-details .job, .sidebar.close .profile-details #log_out { opacity: 0; pointer-events: none; }
        .sidebar .profile-details #log_out { position: absolute; right: 0; width: 50px; text-align: center; color: #fff; font-size: 22px; cursor: pointer; }
        .home-section { position: relative; background: var(--main-bg); min-height: 100vh; left: 260px; width: calc(100% - 260px); transition: all 0.4s ease; padding: 0; }
        .sidebar.close ~ .home-section { left: 78px; width: calc(100% - 78px); }
        
        /* Status Badges */
        .status-badge { display: inline-block; font-size: 0.75rem; font-weight: 600; padding: 0.375rem 0.75rem; border-radius: 9999px; white-space: nowrap; }
        .status-pending { background-color: #ffedd5; color: #c2410c; } /* Orange */
        .status-processing { background-color: #dbeafe; color: #2563eb; } /* Blue */
        .status-review { background-color: #e0e7ff; color: #4338ca; } /* Indigo (For Work Done) */
        .status-completed { background-color: #dcfce7; color: #16a34a; } /* Green */
        .status-cancelled { background-color: #fee2e2; color: #dc2626; } /* Red */
        
        /* Filters */
        .filter-btn { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 600; color: #6b7280; border-bottom: 4px solid transparent; transition: all 0.3s; }
        .filter-btn.active { color: var(--sidebar-blue); border-color: var(--sidebar-blue); font-weight: 700; }
        
        /* Animation */
        .modal-animate { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div class="sidebar">
       <div class="logo-details">
           <img src="images/mit.png" alt="Logo" class="logo-img"> 
           <i class="fa-solid fa-bars" id="btn"></i>
       </div>
       <ul class="nav-links">
           <li><a href="home.html"><i class="fa-solid fa-home"></i><span class="link_name">Home</span></a></li>
           <li><a href="requist.html" class="active"><i class="fa-solid fa-clipboard-list"></i><span class="link_name">My Requests</span></a></li>
           <li><a href="notification.html"><i class="fa-solid fa-bell"></i><span class="link_name">Notifications</span></a></li>
           <li><a href="mydetails.html"><i class="fa-solid fa-user-circle"></i><span class="link_name">My Details</span></a></li>
       </ul>
       <div class="profile-details">
           <img src="https://ui-avatars.com/api/?name=User&background=0D8ABC&color=fff" id="user-avatar" alt="profile">
           <div class="name-job">
               <div class="profile_name" id="sidebar-name">Loading...</div>
               <div class="job">Student</div>
           </div>
           <a href="#" onclick="logout()"><i class="fa-solid fa-right-to-bracket" id="log_out"></i></a>
       </div>
    </div>

    <section class="home-section">
        <div class="flex-1 flex flex-col overflow-hidden h-screen">
            <header class="bg-white shadow-sm flex-shrink-0">
                <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">My Requests</h1>
                    <div class="flex items-center gap-4">
                        <span id="user-name-header" class="font-semibold hidden sm:block">Welcome!</span>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-[--main-bg] p-6">
                <div class="container mx-auto">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                        <h1 class="text-3xl font-bold text-gray-800">Track Status</h1>
                        <div class="flex items-center gap-6 border-b">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="pending">Pending</button>
                            <button class="filter-btn" data-filter="processing">Processing</button>
                            <button class="filter-btn" data-filter="completed">Completed</button>
                        </div>
                    </div>

                    <div id="request-list" class="space-y-5">
                        <p class="text-center text-gray-500">Loading your requests...</p>
                    </div>
                </div>
            </main>
        </div>
    </section>

    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden modal-animate flex flex-col max-h-[90vh]">
            
            <div class="bg-[#1e3a8a] px-6 py-4 flex justify-between items-center flex-shrink-0">
                <h3 class="text-white text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-info-circle"></i> Request Details #<span id="modal-id"></span>
                </h3>
                <button onclick="closeModal()" class="text-white hover:text-red-300 text-2xl transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">Service Type</p>
                        <p id="modal-service" class="font-semibold text-gray-800 text-lg">--</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">Status</p>
                        <div id="modal-status"></div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">Location</p>
                        <p id="modal-location" class="font-medium text-gray-800">--</p>
                    </div>
                     <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">Description</p>
                        <p id="modal-desc" class="text-gray-600 bg-gray-50 p-2 rounded border text-sm">--</p>
                    </div>
                </div>

                <h4 class="text-center font-bold text-gray-700 mb-4 border-b w-max mx-auto px-4 pb-1">PROOF OF WORK</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-64">
                    
                    <div class="flex flex-col h-full">
                        <span class="text-xs font-bold text-red-500 uppercase mb-2 text-center">Before (Issue)</span>
                        <div class="flex-1 bg-gray-100 rounded-lg border flex items-center justify-center overflow-hidden group relative">
                            <img id="img-before" class="w-full h-full object-contain hidden">
                            <span id="no-img-before" class="text-gray-400 text-sm">No Image</span>
                            <a id="link-before" href="#" target="_blank" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-0 group-hover:bg-opacity-40 transition hidden">
                                <span class="text-white font-bold bg-black bg-opacity-60 px-4 py-2 rounded-full">View Full</span>
                            </a>
                        </div>
                    </div>

                    <div class="flex flex-col h-full">
                        <span class="text-xs font-bold text-green-600 uppercase mb-2 text-center">After (Fixed)</span>
                        <div class="flex-1 bg-gray-100 rounded-lg border-2 border-green-500 flex items-center justify-center overflow-hidden relative group">
                            <img id="img-after" class="w-full h-full object-contain hidden">
                            
                            <div id="pending-msg-after" class="text-center">
                                <i id="wait-icon" class="fas fa-clock text-gray-300 text-2xl mb-1"></i>
                                <p id="wait-text" class="text-gray-400 text-xs">Waiting for completion</p>
                            </div>

                            <div id="completed-badge" class="absolute bottom-2 right-2 bg-green-500 text-white rounded-full p-1 shadow hidden">
                                <i class="fas fa-check text-xs"></i>
                            </div>

                            <a id="link-after" href="#" target="_blank" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-0 group-hover:bg-opacity-40 transition hidden">
                                <span class="text-white font-bold bg-black bg-opacity-60 px-4 py-2 rounded-full">View Full</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 flex justify-end">
                <button onclick="closeModal()" class="px-6 py-2 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.querySelector("#btn").onclick = () => document.querySelector(".sidebar").classList.toggle("close");

        const requestListContainer = document.getElementById('request-list');
        const filterButtons = document.querySelectorAll('.filter-btn');
        let myRequestsData = []; 

        // --- 1. INITIALIZE ---
        async function init() {
            // Load User
            try {
                const uRes = await fetch('/api/user');
                const user = await uRes.json();
                if(user.name) {
                    document.getElementById('sidebar-name').innerText = user.name;
                    document.getElementById('user-name-header').innerText = `Welcome, ${user.name}`;
                }
            } catch(e) { console.log("User error"); }

            // Fetch Requests
            try {
                const response = await fetch('/api/my-requests');
                if (response.status === 401) { window.location.href = 'index.html'; return; }
                myRequestsData = await response.json();
                renderRequests(myRequestsData);
            } catch (error) {
                requestListContainer.innerHTML = `<p class="text-center text-red-500">Error loading requests</p>`;
            }
        }

        // --- 2. RENDER LIST ---
        function renderRequests(requests) {
            if (requests.length === 0) {
                requestListContainer.innerHTML = '<p class="text-center text-gray-500">No requests found.</p>';
                return;
            }
            requestListContainer.innerHTML = ''; 
            requests.forEach(req => {
                // Logic: Map 'Work Done' to 'Processing' category for filters
                let filterStatus = req.status.toLowerCase();
                if(filterStatus === 'work done') filterStatus = 'processing';

                // Logic: Display text 'Under Review' if status is 'Work Done'
                let displayStatus = req.status;
                if (req.status === 'Work Done') displayStatus = 'Under Review';

                const { bg, text } = getStatusClass(req.status);
                const date = new Date(req.created_at).toLocaleDateString();
                
                const item = document.createElement('div');
                item.className = 'request-item bg-white rounded-2xl shadow-lg p-5 transition hover:shadow-xl';
                item.dataset.status = filterStatus; 
                
                let icon = 'fas fa-tools';
                if(req.service_type === 'Cleaning') icon = 'fas fa-broom';
                if(req.service_type === 'Electrical') icon = 'fas fa-bolt';

                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex gap-4">
                            <div class="w-12 h-12 ${bg} rounded-full flex items-center justify-center text-xl"><i class="${icon}"></i></div>
                            <div>
                                <h3 class="font-bold text-gray-800">${req.service_type}</h3>
                                <p class="text-sm text-gray-500">${req.building}, ${req.room}</p>
                            </div>
                        </div>
                        <span class="status-badge ${text}">${displayStatus}</span>
                    </div>
                    <div class="mt-4 pt-4 border-t flex justify-between items-center text-sm text-gray-500">
                        <span>${date}</span>
                        <button onclick="openModal(${req.request_id})" class="text-blue-600 font-semibold hover:underline">View Details</button>
                    </div>`;
                requestListContainer.appendChild(item);
            });
        }

        // --- 3. OPEN MODAL (UPDATED) ---
        function openModal(id) {
            const req = myRequestsData.find(r => r.request_id === id);
            if(!req) return;

            document.getElementById('modal-id').innerText = req.request_id;
            document.getElementById('modal-service').innerText = req.service_type;
            document.getElementById('modal-location').innerText = `${req.building}, Room ${req.room}`;
            document.getElementById('modal-desc').innerText = req.description;
            
            // Status Badge Logic
            let displayStatus = req.status;
            if (req.status === 'Work Done') displayStatus = 'Under Review';
            const { text } = getStatusClass(req.status);
            document.getElementById('modal-status').innerHTML = `<span class="status-badge ${text}">${displayStatus}</span>`;

            // Before Image
            const imgBefore = document.getElementById('img-before');
            const noImgBefore = document.getElementById('no-img-before');
            const linkBefore = document.getElementById('link-before');
            if(req.image_path) {
                imgBefore.src = req.image_path; imgBefore.classList.remove('hidden'); noImgBefore.classList.add('hidden'); linkBefore.classList.remove('hidden'); linkBefore.href = req.image_path;
            } else {
                imgBefore.classList.add('hidden'); noImgBefore.classList.remove('hidden'); linkBefore.classList.add('hidden');
            }

            // AFTER IMAGE LOGIC
            // Show image ONLY if 'Completed'. If 'Work Done', show 'Under Review' message.
            const imgAfter = document.getElementById('img-after');
            const pendingMsg = document.getElementById('pending-msg-after');
            const waitText = document.getElementById('wait-text');
            const badge = document.getElementById('completed-badge');
            const linkAfter = document.getElementById('link-after');

            if(req.status === 'Completed' && req.staff_proof_image) {
                // DONE: Show Image
                imgAfter.src = req.staff_proof_image; 
                imgAfter.classList.remove('hidden'); 
                pendingMsg.classList.add('hidden'); 
                badge.classList.remove('hidden');
                linkAfter.classList.remove('hidden'); 
                linkAfter.href = req.staff_proof_image;
            } else {
                // NOT DONE or UNDER REVIEW
                imgAfter.classList.add('hidden'); 
                pendingMsg.classList.remove('hidden'); 
                badge.classList.add('hidden'); 
                linkAfter.classList.add('hidden');

                if (req.status === 'Work Done') {
                    waitText.innerText = "Admin Verification Pending";
                    document.getElementById('wait-icon').className = "fas fa-user-shield text-indigo-300 text-2xl mb-1";
                } else {
                    waitText.innerText = "Waiting for completion";
                    document.getElementById('wait-icon').className = "fas fa-clock text-gray-300 text-2xl mb-1";
                }
            }

            document.getElementById('details-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('details-modal').classList.add('hidden'); }
        function logout() { fetch('/api/logout', {method:'POST'}).then(()=>window.location.href='index.html'); }

        function getStatusClass(status) {
            const s = status.toLowerCase();
            if(s==='pending') return { bg: 'bg-orange-100 text-orange-600', text: 'status-pending' };
            if(s==='assigned') return { bg: 'bg-blue-100 text-blue-600', text: 'status-processing' };
            if(s==='in progress') return { bg: 'bg-purple-100 text-purple-600', text: 'status-processing' };
            if(s==='work done') return { bg: 'bg-indigo-100 text-indigo-600', text: 'status-review' }; // New status style
            if(s==='completed') return { bg: 'bg-green-100 text-green-600', text: 'status-completed' };
            return { bg: 'bg-gray-100', text: 'text-gray-600' };
        }

        // Filters
        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const filter = btn.dataset.filter;
                document.querySelectorAll('.request-item').forEach(item => {
                    if(filter === 'all' || item.dataset.status === filter) item.style.display = 'block';
                    else item.style.display = 'none';
                });
            });
        });

        init();
    </script>
</body>
</html>